name: Deploy to Test Environment

on:
  push:
    branches: [ test ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'test'
        type: choice
        options:
        - test
        - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: test

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.TEST_SSH_PRIVATE_KEY }}

    - name: Add test server to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.TEST_SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to test server
      run: |
        echo "ğŸš€ Starting deployment to test environment..."

        # Create deployment directory on remote server
        ssh ${{ secrets.TEST_SSH_USER }}@${{ secrets.TEST_SERVER_HOST }} << 'EOF'
          mkdir -p ~/aquamind-test
          cd ~/aquamind-test

          # Backup current deployment
          if [ -f "docker-compose.yml" ]; then
            echo "ğŸ“¦ Backing up current deployment..."
            cp docker-compose.yml docker-compose.yml.backup.$(date +%Y%m%d_%H%M%S)
          fi
        EOF

        # Copy updated files to server
        echo "ğŸ“¤ Copying deployment files..."
        scp docker-compose.yml ${{ secrets.TEST_SSH_USER }}@${{ secrets.TEST_SERVER_HOST }}:~/aquamind-test/
        scp -r scripts ${{ secrets.TEST_SSH_USER }}@${{ secrets.TEST_SERVER_HOST }}:~/aquamind-test/

        # Deploy on remote server
        ssh ${{ secrets.TEST_SSH_USER }}@${{ secrets.TEST_SERVER_HOST }} << 'EOF'
          cd ~/aquamind-test

          echo "ğŸ³ Pulling latest Docker images..."
          docker-compose pull

          echo "ğŸ”„ Restarting services..."
          docker-compose down
          docker-compose up -d

          echo "â³ Waiting for services to start..."
          sleep 30

          echo "ğŸ©º Running health checks..."
          # Check if services are running
          if docker-compose ps | grep -q "Up"; then
            echo "âœ… Services are running"
          else
            echo "âŒ Services failed to start"
            docker-compose logs
            exit 1
          fi

          # Run database migrations and setup
          echo "ğŸ—„ï¸ Setting up database..."
          docker-compose exec -T web python manage.py migrate
          docker-compose exec -T web python manage.py shell < scripts/create_admin_user.py

          echo "ğŸ“Š Loading test data..."
          docker-compose exec -T web python manage.py shell < scripts/init_test_data.py

          echo "ğŸ” Running final health check..."
          # Test API endpoints
          if curl -f http://localhost:8000/api/v1/infrastructure/geographies/ > /dev/null 2>&1; then
            echo "âœ… Backend API is responding"
          else
            echo "âŒ Backend API is not responding"
            exit 1
          fi

          if curl -f http://localhost:3000 > /dev/null 2>&1; then
            echo "âœ… Frontend is responding"
          else
            echo "âŒ Frontend is not responding"
            exit 1
          fi
        EOF

    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "ğŸ‰ Deployment to test environment successful!"
          echo "ğŸŒ Frontend: http://${{ secrets.TEST_SERVER_HOST }}:3000"
          echo "ğŸ”— Backend API: http://${{ secrets.TEST_SERVER_HOST }}:8000"
        else
          echo "ğŸ’¥ Deployment to test environment failed!"
          echo "Check the logs above for details."
        fi

  notify:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Send notification
      run: |
        if [ ${{ needs.deploy.result }} == 'success' ]; then
          echo "âœ… Test deployment completed successfully"
        else
          echo "âŒ Test deployment failed"
        fi
