# API Contract Synchronization Guide  
_AquaMind ⊕ AquaMind-Frontend · last updated Aug 2025_

## 1 Purpose
Keep backend and frontend in **lock-step** by propagating every change to  
`api/openapi.yaml` (OpenAPI 3.1, generated by **drf-spectacular ≥ 0.28**).  
Outcome: type-safe React client, zero hand-coded DTO drift, and green Schemathesis.

---

## 2 Automatic Flow (fully operational)

| Step | Repo · Workflow | Key Action |
|------|-----------------|------------|
| 1 | **AquaMind** · `django-tests.yml` | After tests + Schemathesis, upload artifact:<br>`actions/upload-artifact@v4` → **name: `api-spec`** |
| 2 | **AquaMind** · `sync-openapi-to-frontend.yml` | `repository_dispatch` to `aquarian247/AquaMind-Frontend` <br>`event-type: api-spec-updated` <br>Token: `${{ secrets.FRONTEND_REPO_PAT }}` |
| 3 | **AquaMind-Frontend** · `regenerate-api-client.yml` | `curl` raw spec via commit hash:<br>`https://raw.githubusercontent.com/aquarian247/AquaMind/<sha>/api/openapi.yaml` → `tmp/openapi/openapi.yaml` |
| 4 | same job | `npm run generate:api` (openapi-typescript-codegen) |
| 5 | same job | `git diff` → if changed, PR `auto/api-client-update` to **main** |

### Secrets & Permissions
* **FRONTEND_REPO_PAT** (backend repo) – classic PAT with `repo` scope, write access to frontend.
* **GITHUB_TOKEN** (frontend) – default; repo Settings → Actions → Read/Write + “create PRs”.

---

## 3 Manual Fallback

If dispatch fails (e.g. PAT expired):

1. Frontend repo → Actions → **“Manual API Client Sync”**  
2. Input backend branch (`main` or feature) → Run workflow  
3. Same steps 3-5 above; PR created.

---

## 4 Contract Testing Quick-Ref

| Context | Command |
|---------|---------|
| Local full suite | `coverage run --source='.' manage.py test && coverage report` |
| Contract only (10 ex) | `schemathesis run --hypothesis-max-examples 10 api/openapi.yaml` |
| Hooks module | `aquamind.utils.schemathesis_hooks` (export as `SCHEMATHESIS_HOOKS`) |
| Auth token (CI settings) | `python manage.py get_ci_token --settings=aquamind.settings_ci` |

---

## 5 Troubleshooting Checklist

| Symptom | Likely Cause · Fix |
|---------|-------------------|
| `Resource not accessible by token` in backend sync | PAT missing `repo` scope or wrong user permissions |
| Frontend workflow “Artifact not found” | Using old artifact download step – _should use **curl**_ |
| PR not created | No diff (spec unchanged) _or_ repo Settings “Allow PRs” disabled |
| Schemathesis SQLite overflow | Ensure hook `clamp_integer_schema_bounds` active |

---

## 6 File & Script Map

| File | Purpose |
|------|---------|
| **backend** `api/openapi.yaml` | Single source of truth (auto-generated) |
| `.github/workflows/django-tests.yml` | Generates spec & artifact |
| `.github/workflows/sync-openapi-to-frontend.yml` | Dispatch event to frontend |
| **frontend** `.github/workflows/regenerate-api-client.yml` | Fetch spec & rebuild client |
| `package.json` → `generate:api` | `openapi --input tmp/openapi/openapi.yaml --output client/src/api/generated --client fetch --useUnionTypes` |

---

Stay contract-first: _any serializer / viewset change → regenerate spec → commit → CI takes it from there._  
When in doubt, run `npm run generate:api` locally and push the PR manually.
